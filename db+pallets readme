Di seguito trovi il README COMBINATO ‚Äî DB + API di SPST Pallets, scritto in stile ‚ÄúPadre Nostro‚Äù, quindi:
	‚Ä¢	vincolante
	‚Ä¢	non descrittivo
	‚Ä¢	senza fallback
	‚Ä¢	coerente con SPST Operations
	‚Ä¢	pronto per essere incollato nel repo
Dopo questo documento, passiamo direttamente al deploy delle API senza ridiscutere nulla.

üü¶ SPST PALLETS ‚Äî DATABASE + API CONTRACT (FREEZE)
‚ö†Ô∏è DOCUMENTO VINCOLANTE
Questo documento definisce in modo definitivo:
	‚Ä¢	il modello dati di SPST Pallets
	‚Ä¢	il comportamento delle API
	‚Ä¢	i confini invalicabili tra:
	‚ó¶	core SPST (api/spedizioni)
	‚ó¶	orchestrazione SPST Pallets
Qualsiasi modifica che contraddice quanto scritto qui √® da considerarsi BREAKING CHANGE‚Ä®e NON VA INTRODOTTA senza versioning esplicito.

üéØ OBIETTIVO DI SPST PALLETS
SPST Pallets √® un prodotto tecnologico di orchestrazione che:
	‚Ä¢	aggrega spedizioni pallet gi√† create in SPST
	‚Ä¢	organizza ritiri tramite WAVE
	‚Ä¢	consegna ai trasportatori un flusso ordinato, leggibile e completo
	‚Ä¢	non modifica spedizioni, colli o stati core
SPST Pallets NON √à:
	‚Ä¢	una linea di groupage
	‚Ä¢	un gestionale trasportatori
	‚Ä¢	un duplicato di api/spedizioni
SPST Pallets √à:
	‚Ä¢	uno strato di coordinamento
	‚Ä¢	una control tower
	‚Ä¢	un moltiplicatore di affidabilit√† e volume

üß† PRINCIPIO FONDAMENTALE
DATABASE = UNICA SOURCE OF TRUTH‚Ä®API = ADAPTER‚Ä®WAVE = UNIT√Ä OPERATIVA‚Ä®SPEDIZIONE = OGGETTO IMMUTABILE
Se una logica tenta di:
	‚Ä¢	ricostruire dati
	‚Ä¢	dedurre informazioni
	‚Ä¢	scrivere dove dovrebbe solo leggere
‚ùå √à VIETATA

1Ô∏è‚É£ SOURCE OF TRUTH (DB CORE ‚Äî NON MODIFICABILE)
üì¶ SPEDIZIONI
Fonte: spst.shipments
SPST Pallets:
	‚Ä¢	legge le spedizioni
	‚Ä¢	non le modifica mai
Campi utilizzati:
	‚Ä¢	id
	‚Ä¢	human_id (SP-...)
	‚Ä¢	formato_sped
	‚Ä¢	mittente_cap
	‚Ä¢	mittente_citta
	‚Ä¢	giorno_ritiro
	‚Ä¢	allegati (es. ldv)
‚ùå Vietato:
	‚Ä¢	alterare lo stato spedizione
	‚Ä¢	sovrascrivere la data di ritiro
	‚Ä¢	duplicare spedizioni
	‚Ä¢	scrivere in extras

üì¶ COLLI
Fonte: spst.packages (UNICA)
Regola assoluta:
	‚Ä¢	1 riga = 1 collo
	‚Ä¢	per pallet: 1 collo = 1 pallet
üëâ Numero pallet = COUNT(packages)‚Ä®üëâ Mai salvato, mai cachato, mai duplicato

2Ô∏è‚É£ TERRITORIALIT√Ä (CAMPANIA)
üìç Regola di ammissibilit√†
Una spedizione √® eleggibile a SPST Pallets se:
	1	formato_sped indica PALLET
	2	MITTENTE IN CAMPANIA, determinato in questo ordine:
1Ô∏è‚É£ Regola primaria (deterministica)

shipments.mittente_cap
‚Üí spst.italy_caps.cap
‚Üí regione = 'Campania'
2Ô∏è‚É£ Fallback controllato (temporaneo)
Se il CAP non √® presente:

lower(shipments.mittente_citta)
‚Üí spst.campania_cities_fallback
‚ùå Vietato:
	‚Ä¢	inferire regione da range CAP
	‚Ä¢	usare regex o logiche ‚Äúeuristiche‚Äù
	‚Ä¢	chiamare servizi esterni

3Ô∏è‚É£ WAVE (UNIT√Ä OPERATIVA)
üì¶ Definizione
Una WAVE √®:
	‚Ä¢	un batch operativo di ritiri pallet
	‚Ä¢	assegnato a un solo trasportatore
	‚Ä¢	pianificato su una data unica
Una wave:
	‚Ä¢	contiene spedizioni
	‚Ä¢	NON contiene colli
	‚Ä¢	NON altera le spedizioni

üóÇÔ∏è Tabelle SPST Pallets
spst.pallet_waves
Fonte operativa delle wave.
Campi chiave:
	‚Ä¢	id
	‚Ä¢	code (es. WAVE-2026-01-08-SDF-01)
	‚Ä¢	carrier_id
	‚Ä¢	status
	‚Ä¢	planned_pickup_date
	‚Ä¢	pickup_window
	‚Ä¢	notes
	‚Ä¢	created_at
	‚Ä¢	updated_at
Stati ammessi (ENUM italiano):
	‚Ä¢	bozza
	‚Ä¢	inviata
	‚Ä¢	in_corso
	‚Ä¢	completata
	‚Ä¢	annullata
‚ùå Vietato:
	‚Ä¢	associare pi√π carrier a una wave
	‚Ä¢	modificare retroattivamente una wave senza tracciabilit√†

spst.pallet_wave_items
Relazione WAVE ‚Üî SPEDIZIONI
Regole:
	‚Ä¢	1 spedizione ‚Üí 1 sola wave
	‚Ä¢	enforced DB con UNIQUE(shipment_id)
Campi:
	‚Ä¢	wave_id
	‚Ä¢	shipment_id
	‚Ä¢	shipment_human_id (denormalizzato, read-only)
	‚Ä¢	requested_pickup_date (snapshot)
	‚Ä¢	planned_pickup_date
‚ùå Vietato:
	‚Ä¢	inserire spedizioni non pallet
	‚Ä¢	inserire spedizioni fuori Campania
	‚Ä¢	duplicare shipment in pi√π wave

4Ô∏è‚É£ TRASPORTATORI
üöö Fonte
	‚Ä¢	spst.carriers
	‚Ä¢	spst.carrier_users
Regole:
	‚Ä¢	il trasportatore vede solo le sue wave
	‚Ä¢	read-only (MVP)
‚ùå Vietato:
	‚Ä¢	consentire update diretti
	‚Ä¢	consentire accesso a shipment core

5Ô∏è‚É£ API ‚Äî RESPONSABILIT√Ä E LIMITI
üîí CONFINE SACRO
üëâ api/spedizioni NON SI TOCCA‚Ä®üëâ SPST Pallets vive in namespace dedicato
Namespace ammesso

/api/pallets/*

6Ô∏è‚É£ API DISPONIBILI (CANONICHE)
üîπ GET /api/pallets/pool
Backoffice only
Ritorna:
	‚Ä¢	spedizioni pallet Campania
	‚Ä¢	non ancora assegnate a wave
Usa:
	‚Ä¢	spst.shipments
	‚Ä¢	spst.packages
	‚Ä¢	spst.italy_caps
	‚Ä¢	spst.campania_cities_fallback
‚ùå Non:
	‚Ä¢	crea
	‚Ä¢	modifica
	‚Ä¢	arricchisce dati

üîπ POST /api/pallets/waves
Staff only
Crea una wave.
Regole:
	‚Ä¢	minimo 6 pallet totali
	‚Ä¢	tutte le spedizioni devono essere valide
	‚Ä¢	inserisce:
	‚ó¶	pallet_waves
	‚ó¶	pallet_wave_items
‚ùå Vietato:
	‚Ä¢	creare wave senza validazioni DB
	‚Ä¢	accettare shipment arbitrary

üîπ GET /api/pallets/waves
Staff / Carrier
	‚Ä¢	Staff: vede tutte
	‚Ä¢	Carrier: solo le proprie (RLS)

üîπ GET /api/pallets/waves/:id
Staff / Carrier
Ritorna:
	‚Ä¢	wave
	‚Ä¢	spedizioni incluse
	‚Ä¢	dati operativi
	‚Ä¢	link DDT (da shipments.ldv)

7Ô∏è‚É£ AUTENTICAZIONE & SICUREZZA
	‚Ä¢	Supabase Auth
	‚Ä¢	session-based
	‚Ä¢	Nessun header custom
	‚Ä¢	Nessuna chiave pubblica per backoffice
Ruoli:
	‚Ä¢	client ‚Üí nessun accesso
	‚Ä¢	carrier ‚Üí read-only via RLS
	‚Ä¢	staff ‚Üí service role + requireStaff()

8Ô∏è‚É£ REGOLE D‚ÄôORO (API)
	‚Ä¢	le API non calcolano
	‚Ä¢	le API non deducono
	‚Ä¢	le API non riparano dati
	‚Ä¢	le API espongono il DB
	‚Ä¢	ogni validazione vera avviene prima della scrittura
Se una API:
	‚Ä¢	‚Äúsembra comoda‚Äù
	‚Ä¢	fa lavoro sporco
	‚Ä¢	nasconde errori
üëâ √à SBAGLIATA

üßä CONCLUSIONE
Questo documento √®:
	‚Ä¢	la costituzione di SPST Pallets
	‚Ä¢	il confine tra ordine e caos
	‚Ä¢	il riferimento per DB, API, UI, carrier portal
Va:
	‚Ä¢	rispettato
	‚Ä¢	difeso
	‚Ä¢	usato come filtro decisionale
